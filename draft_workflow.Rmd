---
title: "draft_workflow"
author: "Renata Diaz"
date: "4/8/2019"
output: github_document
---

```{r setup, include=FALSE}
library(feasiblesads)
library(ggplot2)
set.seed(5)
```


## Define S and N

```{r define S and N}
S = 5
N = 30
```

## Simulate an "empirical" RAD
```{r create empirical}
empirical_rad <- sample_fs(nsamples = 1, nspec = S, nind = N)[[2]] %>%
  t() %>%
  as.vector()
empirical_rad
```

## Sample from the feasible set given S and N

```{r sample feasible set}
sim_rads <- sample_fs(nsamples = 1000, nspec = S, nind = N)[[2]] %>%
  t() %>%
  as.data.frame() %>%
  dplyr::distinct()
head(sim_rads)
dim(sim_rads)
```

## Make sure the empirical RAD is in the sampled set

```{r include empirical in samples}
sim_rads <- rbind(sim_rads, empirical_rad) %>%
    dplyr::distinct()

dim(sim_rads)
```

## Identify the central tendency of the (samples of the) feasible set

### Using Locey & White's approach

```{r LW central tendency}
lw_ct <- find_ct(sim_rads)
lw_ct
```

### Using new criterion

```{r new central tendency}
all_rad_ps <- vector(length = nrow(sim_rads), mode = 'numeric')

for(i in 1:nrow(sim_rads)) {
  all_rad_ps[i] <- new_ct_criterion(focal_RAD = as.integer(sim_rads[i,]), 
                                    pool_RADs = sim_rads)[[1]]
  }

new_ct <- sim_rads[which(all_rad_ps == max(all_rad_ps)),]
new_ct
```

## Evaluate the overall likelihood of the empirical RAD compared to the feasible set

```{r empirical overall likelihood}
empirical_p <- new_ct_criterion(focal_RAD = empirical_rad, 
                                pool_RADs = sim_rads)[[1]]

sim_ecdf <- ecdf(all_rad_ps)
sim_ecdf(empirical_p)


p_plot <- ggplot(data = as.data.frame(all_rad_ps)) + 
  geom_histogram(binwidth = 0.25, aes(x = as.data.frame(all_rad_ps)$all_rad_ps)) +
    xlim(min(all_rad_ps) - 1, max(all_rad_ps) +1) + 
    geom_vline(xintercept = empirical_p, colour  ='red') +
  theme_bw()

p_plot

```

## Evaluate the empirical likelihood at each rank

```{r empirical rank likelihood}
all_rad_all_ps <- matrix(nrow = nrow(sim_rads), ncol = ncol(sim_rads))
colnames(all_rad_all_ps) <- c(1:5)

for(i in 1:nrow(sim_rads)) {
all_rad_all_ps[i, ] <-new_ct_criterion(focal_RAD = as.integer(sim_rads[i,]), pool_RADs = sim_rads)[[2]]
}

all_rad_all_ps <- as.data.frame(all_rad_all_ps) %>%
  stack()

empirical_all_ps <- new_ct_criterion(focal_RAD = empirical_rad,
                                     pool_RADs = sim_rads)[[2]]

rank_p_plot <-ggplot(data = all_rad_all_ps) + 
  geom_jitter(data = all_rad_all_ps, aes(x = all_rad_all_ps$ind, y = all_rad_all_ps$values)) + 
  geom_point(data = as.data.frame(empirical_all_ps), aes(x = c(1:S), y =  as.data.frame(empirical_all_ps)$empirical_all_ps), colour= 'red') +
  theme_bw()

rank_p_plot


empirical_p_quantiles <- vector(length = S)

for(i in 1:S){
  this_rank_ecdf <- ecdf(dplyr::filter(all_rad_all_ps, ind == i)$values)
  empirical_p_quantiles[i] <- this_rank_ecdf(empirical_all_ps[i])
}

empirical_rank_plot <- ggplot(data = as.data.frame(empirical_p_quantiles)) +
  geom_point(data = as.data.frame(empirical_p_quantiles), aes(x = c(1:S), y =  as.data.frame(empirical_p_quantiles)$empirical_p_quantiles)) +
  ylim(c(0, 1)) + 
  theme_bw()
empirical_rank_plot

```
